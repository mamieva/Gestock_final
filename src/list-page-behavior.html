<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<script>
    var AWSLBehaviors = AWSLBehaviors || {};

    (function() {
        AWSLBehaviors.ListVaadinBehavior = {
            properties: {
                oname: {
                    type: String,
                },
                filterName: {
                    type: String,
                    value: ""
                },
                ajaxlist: {
                    type: Object
                },
                items: {
                    type: Array,
                },
                titleSearch: {
                    type: String
                },
                lastTitle: {
                    type: String
                },
                toserver: {
                    type: Object,
                    value: function() {
                        var obj = {
                            oname: "",
                            filterName: "",
                            sortIndex: 0,
                            sortDir: "asc",
                            dofastsearch: false,
                            fastsearch: "",
                            data: {},
                            topRecords: 100,
                            first: true
                        };

                        return obj;
                    }
                },
                fastsearch: {
                    type: String
                },
                itemsCount: {
                    type: Number,
                    value: 0
                },
                serverSideSorting: {
                    type: Boolean,
                    value: false
                }
            },
            spinner: null,
            wasAttached: false,
            firstResponse: false,
            refreshPending: false,

            insertSpinner: function() {
                if (this.getItemsList().parentNode === this) {
                    if (Polymer.dom(this).childNodes.length == 0) {
                        this.async(this.insertSpinner, 100);
                    } else {
                        Polymer.dom(this).insertBefore(this.spinner, Polymer.dom(this).childNodes[0]);
                    }
                } else {
                    Polymer.dom(this.getItemsList().parentNode).insertBefore(this.spinner, this.getItemsList());
                }
            },
            ready: function() {
                //
                //console.log('attached');
                console.log(this.route);
                this.ajaxlist = document.createElement('iron-ajax');

                this.ajaxlist.method = 'GET';
                //this.ajaxlist.contentType = 'application/json';
                this.ajaxlist.handleAs = 'json';

                this.ajaxlist.addEventListener('response', this._handleResponse.bind(this));
                this.ajaxlist.addEventListener('error', this._handleError.bind(this));

                //this.ajaxlist.url = "https://jsonplaceholder.typicode.com/" + this.data;

                //this.$.divAjax.appendChild(this.ajaxlist);

                //this.ajaxlist.generateRequest();

                //this.toserver.oname = this.oname;

                this.getItemsList().reallythis = this;
                this.getItemsList().addEventListener('selected-items-changed', (this)._selectedItemChanged);
                this.getItemsList().addEventListener('sort-order-changed', this._sortOrderChanged);
            },
            _handleResponse : function(response){
              let keys = Object.keys(this.ajaxlist.lastResponse[0]);
              let grid = this.getItemsList();
              keys.forEach(function(element){
                //console.log(element);
                //if(element === 'id'){
                  var col = {"name" : element, "sortable": "true"};
                //}
                //else {
                  //var col = {"name" : element};
                //}
                grid.addColumn(col);
              });

              // for( var name in keys){
              //   //var col = {"name" : name.1};
              //   console.log(name.value);
              //   //this.getItemsList().addColumn(name);
              // }
              this.items = response.detail.response;
              console.log(Object.keys(this.ajaxlist.lastResponse[0]));
              console.log(response.detail.response[0]);
              console.log(this.items);
             //  return null;
            },
            _handleError: function(){
              debugger
            },
            _selectedItemChangedNotify: function(key, select) {
              console.log("click");
            },
            getItemsList: function() {
                return null;
            },
            getFilter: function() {
                return null;
            },
            getListToolbar: function() {
                return null;
            },
            customizeItemsList: function() {},
            _openFilter: function() {
                this.getFilter()._openFilter();
            },
            _selectedItemChanged: function(event){
              return null;
            }
        }
    })();
</script>
