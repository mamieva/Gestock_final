<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<dom-module id="users-form">
    <template>
        <style>
             :host {
                display: block;
            }
            
            .container {
                display: block;
                margin: 20px 0 0 20px;
                width: 100%;
            }
            
            form {
                width: 900px;
            }
            
            paper-input {
                display: block;
                width: 100%;
                margin: auto;
            }
            .botonera{
                margin: 10px 0 0 0;
            }
            
            iron-icon,
            div[suffix] {
                color: hsl(0, 0%, 50%);
                margin-right: 12px;
            }
        </style>
<app-route route="{{route}}" pattern="/:user" data="{{userData}}" tail="{{routeTail}}" id="routeManager"></app-route>
<div id="ajaxContainer">
    <iron-ajax id="userAjax" handle-as="json" content-type="application/json" debounce-duration="300"></iron-ajax>
    <iron-ajax id="updateAjax"></iron-ajax>
</div>
<div class="container">
    <h3>Usuario</h3>
    <form is="iron-form" method="POST" id="userForm">
        <paper-input id="username" name="username" label="Usuario" error-message="Debe ingresar un email válido!" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}"
            auto-validate required>
            <iron-icon icon="mail" prefix></iron-icon>
            <!--<div suffix>@email.com</div>-->
        </paper-input>
        <paper-input id="password" password type="password" name="password" label="Contraseña" pattern="(?=^.{8,}$)((?=.*\d)|(?=.*\W+))(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$"
            auto-validate error-message="Debe contener una mayúscula,una minúscula, un número y 8 caracteres" required>
            <iron-icon icon="communication:vpn-key" prefix></iron-icon>
        </paper-input>
        <paper-dropdown-menu label="Estado" name="status" required>
            <paper-listbox id="status" class="dropdown-content" attr-for-selected="name">
                <paper-item name="ACTIVO">ACTIVO</paper-item>
                <paper-item name="INACTIVO">INACTIVO</paper-item>
            </paper-listbox>
        </paper-dropdown-menu>
        <div class="botonera">
            <paper-button raised submit id="create">Agregar</paper-button>
            <paper-button raised submit id="apply_changes">Modificar</paper-button>
            <paper-button raised submit id="delete">Eliminar</paper-button>
            <paper-button raised id="reset">Limpiar</paper-button>
        </div>
        <div class="output"></div>
    </form>
    <paper-toast id="toastOk" text="" class="fit-bottom"></paper-toast>
    <paper-toast id="toastError" text="" class="fit-bottom"></paper-toast>
</div>
</template>
<script>
    Polymer({
        is: 'users-form',
        properties: {
            route: {
                type: Object
            },
            key: {
                type: String
            },
            ajaxlist: {
                type: Object
            },
            url: {
                type: String,
                value: 'http://localhost:3000/user'
            },
            token: {
                type: String
            },
            user: {
                type: Object
            }
        },
        observers: [
            "_viewChanged(key)"
        ],
        listeners: {
            'iron-form-response': '_formResponse',
            'iron-form-submit': '_formSubmit',
            'iron-form-error': '_formError',
            'iron-form-presubmit': '_formPresubmit',
            'iron-form-invalid': '_formInvalid',
            'create.tap': '_createSubmit',
            'reset.tap': '_reset',
            'apply_changes.tap': '_updateUser'
        },
        ready: function () {
            //cargar formulario
            this._getForm().reallythis = this;
            // cargar eventos del ajax
            this.$.userAjax.reallythis = this;
            this.$.userAjax.addEventListener('response', this._handleResponse.bind(this));
            this.$.userAjax.addEventListener('error', this._handleError.bind(this));
            ///
            this.$.updateAjax.reallythis = this;
            this.$.updateAjax.addEventListener('response', this._handleResponseUpdate.bind(this));
            this.$.updateAjax.addEventListener('error', this._handleError.bind(this));
        },
        _handleResponse: function (response) {
            console.log(response.detail.response.data);
            var user = response.detail.response.data;
            this.user = user;
            this.$.username.value = user.username;
            this.$.status.selected = user.status;
            if (user.status == 'ACTIVO') {
                this.$.delete.style.display = 'none';
            }

        },
        _handleError: function (error) {
            console.log(error);
            this.showError('Se produjo un error al obtener el usuario');
        },
        _handleResponseUpdate: function (response) {
            console.log(response.detail.response);
            var update = response.detail.response;            
            this.showMessage('El usuario ha sido actualizado con exito');
            window.location.reload();
        },
        _getUser: function () {
            this.$.userAjax.headers = {
                'x-access-token': this.token
            };
            this.$.userAjax.url = this.url + '/' + this.key;
            this.$.userAjax.generateRequest();
        },
        _updateUser: function (event) {
            this.$.updateAjax.headers = {
                'x-access-token': this.token
            };
            this.$.updateAjax.method = 'PUT';
            this.$.updateAjax.url = this.url + '/' + this.key;
            this.$.updateAjax.contentType = "application/x-www-form-urlencoded";
            this.$.updateAjax.debounceDuration = "300";
            var serialize = this._getForm().serialize();
            if (this.user.status == serialize.status) {
                this.showError('No se registraron cambios');
            }
            else {
                this.$.updateAjax.body = serialize;
                this.$.updateAjax.generateRequest();
                // window.location.reload();
            }
        },
        _createSubmit: function (event) {
            //var token = JSON.parse(window.localStorage.session).token
            this._getForm().headers = {
                'x-access-token': this.token
            };
            this._getForm().method = 'POST';
            this._getForm().action = this.url;
            var user = this._getForm().serialize();
            user.token = JSON.parse(window.localStorage.session).token;
            this._getForm().params = user;
            //console.log(user);
            this.$.userForm.submit();
        },
        _applychangesSubmit: function (event) {
            //var token = JSON.parse(window.localStorage.session).token
            this._getForm().headers = {
                'x-access-token': this.token
            };
            this._getForm().method = 'PUT';
            this._getForm().action = this.url + '/' + this.key;
            this._getForm().contentType = "application/x-www-form-urlencoded";
            //var user = this._getForm().serialize();
            //user.token = JSON.parse(window.localStorage.session).token;
            //this._getForm().params = user;
            console.log(this._getForm());
            this.$.userForm.submit();
        },
        _reset: function (e) {
            this.$.userForm.reset();
        },
        _formSubmit: function () {
            //this.querySelector('.output').innerHTML = JSON.stringify(event.detail);
        },
        _getForm: function () {
            return this.$.userForm;
        },
        _formPresubmit: function () {
            console.log("presubmit");
        },
        _formInvalid: function (e) {
            var msg = 'Verifique los datos ingresados';
            this.showMessage(msg);
        },
        _formError: function (error) {
            //console.log('a',error.detail.request.response);
            var msg = error.detail.request.response.message;
            this.showMessage(msg);
        },
        showError: function (errorMessage) {
            //console.log("error msg");
            this.$.toastError.text = errorMessage;
            this.$.toastError.fitInto = this.$.userForm;
            //console.log(this.$.toastError.open());
            this.$.toastError.open();
        },
        showMessage: function (message) {
            this.$.toastOk.text = message;
            this.$.toastOk.fitInto = this.$.userForm;
            this.$.toastOk.open();
        },
        _formResponse: function () {
            this.showMessage("aceptado");
        },
        _viewChanged: function (key) {
            //Cargar token cuando se ingrese a la pantalla de formulario
            if (typeof window.localStorage.session !== "undefined") {
                this.token = JSON.parse(window.localStorage.session).token;
            }
            // Limpiar formulario
            this.$.userForm.reset();
            //Prendemos los botones
            this.$.create.style.display = 'inline-block';
            this.$.reset.style.display = 'inline-block';
            this.$.delete.style.display = 'inline-block';
            this.$.apply_changes.style.display = 'inline-block';
            this.$.username.disabled = null;
            this.$.password.disabled = null;
            this.$.password.style.display = 'inline-block';
            //
            if (key != '' && key != 'undefined') {
                this.$.username.disabled = 'disabled';
                this.$.password.disabled = 'disabled';
                this.$.password.style.display = 'none';
                this.$.create.style.display = 'none';
                this.$.reset.style.display = 'none';
                this._getUser();
            }
            else {
                this.$.delete.style.display = 'none';
                this.$.apply_changes.style.display = 'none';
            }
        }
    });
</script>
</dom-module>