<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<dom-module id="users-form">
    <template>
        <style>
             :host {
                display: block;
            }
            
            .container {
                display: block;
                margin: 20px 0 0 20px;
                width: 100%;
            }
            
            form {
                width: 100%;
            }
            
            paper-input {
                display: block;
                width: 100%;
                margin: auto;
            }
            
            iron-icon,
            div[suffix] {
                color: hsl(0, 0%, 50%);
                margin-right: 12px;
            }
        </style>
        <app-route route="{{route}}"
                   pattern="/:user"
                   data="{{userData}}"
                   tail="{{routeTail}}"
                   id="routeManager">
        <iron-ajax id="userAjax" handle-as="json" content-type="application/json" debounce-duration="300"></iron-ajax>
        <div class="container">
            <h3>Usuario</h3>
            <form is="iron-form" method="POST" id="userForm">
                <paper-input id="username" name="username" label="Usuario" error-message="Debe ingresar un email válido!" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}"
                    auto-validate required >
                    <iron-icon icon="mail" prefix></iron-icon>
                    <!--<div suffix>@email.com</div>-->
                </paper-input>
                <paper-input id="password" password type="password" name="password" label="Contraseña" pattern="(?=^.{8,}$)((?=.*\d)|(?=.*\W+))(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$"
                    auto-validate error-message="Debe contener una mayúscula,una minúscula, un número y 8 caracteres" required>
                    <iron-icon icon="communication:vpn-key" prefix></iron-icon>
                </paper-input>
                <paper-dropdown-menu  label="Estado" name="status" required>
                    <paper-listbox id="status" class="dropdown-content" attr-for-selected="name" selected="INACTIVO">
                        <paper-item name="ACTIVO">ACTIVO</paper-item>
                        <paper-item name="INACTIVO">INACTIVO</paper-item>
                    </paper-listbox>
                </paper-dropdown-menu>
                <paper-button raised submit id="submit">Agregar</paper-button>
                <paper-button raised id="reset">Limpiar</paper-button>
                <div class="output"></div>
            </form>
            <paper-toast id="toastOk" text="" class="fit-bottom"></paper-toast>
        </div>
    </template>
    <script>
        Polymer({
            is: 'users-form',
            properties: {
                route:{
                    type: Object
                },
                key: {
                    type: String
                },
                ajaxlist: {
                    type: Object
                },
                url: {
                    type: String,
                    value: 'http://localhost:3000/user'
                },
                token: {
                    type: String
                }
            },
            observers: [
                "_viewChanged(key)"
            ],
            listeners: {
                'iron-form-response': '_formResponse',
                'iron-form-submit': '_formSubmit',
                'iron-form-error': '_formError',
                'iron-form-presubmit': '_formPresubmit',
                'iron-form-invalid': '_formInvalid',
                'submit.tap': '_submit',
                'reset.tap': '_reset'
            },
            ready: function () {
                if (typeof window.localStorage.session !== "undefined") {
                    this.token = JSON.parse(window.localStorage.session).token;
                }
                //console.log(this.key);
                //cargar formulario
                this._getForm().reallythis = this;
                this._getForm().action = this.url;                
                //Cargar iron-ajax
                // this.ajaxlist.method = 'GET';
                // this.ajaxlist = document.createElement('iron-ajax');
                // this.ajaxlist.handleAs = 'json';
                // //
                this.$.userAjax.reallythis = this;
                this.$.userAjax.addEventListener('response', this._handleResponse.bind(this));
                this.$.userAjax.addEventListener('error', this._handleError.bind(this));
            },
            _handleResponse: function (response) {
                console.log(response.detail.response.data);
                var user = response.detail.response.data;
                this.$.username.value = user.username;
                this.$.status.selected = user.status;

            },
            _handleError: function () {
                null
            },
            _submit: function (event) {                
                //var token = JSON.parse(window.localStorage.session).token
                this._getForm().headers = {
                    'x-access-token': this.token
                };
                var user = this.$.userForm.serialize();
                user.token = JSON.parse(window.localStorage.session).token;
                this._getForm.params = user;
                //console.log(user);
                this.$.userForm.submit();
            },
            _reset: function (e) {
                this.$.userForm.reset();
            },
            _formSubmit: function () {
                //this.querySelector('.output').innerHTML = JSON.stringify(event.detail);
            },
            _getForm: function () {
                return this.$.userForm;
            },
            _formPresubmit: function () {
                console.log("presubmit");
            },
            _formInvalid: function (e) {
                var msg = 'Verifique los datos ingresados';
                this.showMessage(msg);
            },
            _formError: function (error) {
                //console.log('a',error.detail.request.response);
                var msg = error.detail.request.response.message;
                this.showMessage(msg);
            },
            showError: function (errorMessage) {
                //console.log("error msg");
                this.$.toastError.text = errorMessage;
                this.$.toastError.fitInto = this.$.userForm;
                //console.log(this.$.toastError.open());
                this.$.toastError.open();
            },
            showMessage: function (message) {
                this.$.toastOk.text = message;
                this.$.toastOk.fitInto = this.$.userForm;
                this.$.toastOk.open();
            },
            _formResponse: function () {
                this.showMessage("aceptado");
            },
            _viewChanged: function(key){
                
                if (key != '' && key != 'undefined'){
                    console.log(key);
                    this.$.userAjax.headers = {
                        'x-access-token': this.token
                    };
                    this.$.userAjax.url = this.url + '/' + key;
                    this.$.userAjax.generateRequest();
                }
            }
        });
    </script>
</dom-module>